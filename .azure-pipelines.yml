trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  IMAGE_TAG: $(Build.BuildId)
  ACR_NAME: toyshopacr12345
  ACR_LOGIN_SERVER: toyshopacr12345.azurecr.io

stages:
- stage: TerraformInfra
  jobs:
  - job: BuildInfra
    steps:
    - task: TerraformInstaller@1
      inputs:
        terraformVersion: '1.5.0'

    - script: |
        cd infra
        terraform init
        terraform apply -auto-approve
      displayName: 'Apply Terraform'

# - stage: BuildImages
#   dependsOn: TerraformInfra
#   jobs:
#   - job: Build
#     steps:
#       - script: |
#           make build
#         displayName: 'Run Makefile Build'

- stage: PushImages
  dependsOn: TerraformInfra
  jobs:
  - job: pushImages
    steps:
      - script: |
          make get-azure-resources
        displayName: 'Builds all container images and pushes to ACR'

# - stage: DeployToAKS
#   dependsOn: PushImages
#   jobs:
#   - job: Deploy
#     steps:
#     - script: |
#         make deploy-azure
#       displayName: 'Deploy to AKS cluster'
