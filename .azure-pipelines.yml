trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
# ğŸ” Azure Login (starter stage)
- stage: AzureLogin
  jobs:
  - job: login
    steps:
    - task: AzureCLI@2
      inputs:
        azureSubscription: 'AzureDevopsSP-MSDN'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "âœ… Logged in to Azure!"

# ğŸ§± Terraform Infra
- stage: TerraformInfra
  dependsOn: AzureLogin
  jobs:
  - job: buildInfra
    steps:
    - task: AzureCLI@2  # ğŸ” Login here too
      inputs:
        azureSubscription: 'AzureDevopsSP-MSDN'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "âœ… Logged in to Azure for Terraform"

    - script: |
        echo "ğŸ§± Installing Terraform..."
        curl -sLo terraform.zip https://releases.hashicorp.com/terraform/1.5.0/terraform_1.5.0_linux_amd64.zip
        unzip terraform.zip
        sudo mv terraform /usr/local/bin/
        terraform -v
      displayName: 'Install Terraform'

    - script: |
        cd infra
        terraform init
        terraform apply -auto-approve
      displayName: 'Apply Terraform'

# ğŸ³ Build and Push Images
- stage: BuildImages
  dependsOn: TerraformInfra
  jobs:
  - job: buildpushImages
    steps:
    - task: AzureCLI@2  # ğŸ” Login to access ACR
      inputs:
        azureSubscription: 'AzureDevopsSP-MSDN'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "âœ… Logged in to Azure for ACR access"

    - script: |
        make get-azure-resources
      displayName: 'Builds all container images and pushes to ACR'

# ğŸš€ Deploy to AKS
- stage: DeployToAKS
  dependsOn: BuildImages
  jobs:
  - job: Deploy
    steps:
    - task: AzureCLI@2  # ğŸ” Login to pull kube credentials
      inputs:
        azureSubscription: 'AzureDevopsSP-MSDN'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "âœ… Logged in to Azure to deploy to AKS"

    - script: |
        make deploy-azure
      displayName: 'Deploy to AKS cluster'

# âœ¨ Install Flux
- stage: InstallFlux
  dependsOn: DeployToAKS
  jobs:
  - job: fluxInstall
    steps:
    - checkout: self

    - task: AzureCLI@2  # ğŸ” Login to get AKS access and install Flux
      inputs:
        azureSubscription: 'AzureDevopsSP-MSDN'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ğŸ”‘ Logging in to AKS"
          az aks get-credentials --resource-group toyshop-rg --name toyshop-aks

          echo "ğŸ”§ Installing Flux CLI"
          curl -s https://fluxcd.io/install.sh | bash
          export PATH=$PATH:/home/vsts/.flux/bin

          echo "ğŸ“¦ Bootstrapping Flux"
          flux bootstrap github \
            --owner=ukez15 \
            --repository=technical-code-challenge \
            --branch=main \
            --path=clusters/prod \
            --personal
